name: CI

on:
  push:
    branches: [main]
  pull_request:

env:
  UV_PROJECT_ENVIRONMENT: .venv

jobs:
  checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install Node.js dependencies
        run: npm ci

      - name: Set up Python and uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.14'

      - name: Install Python dependencies
        run: |

          uv venv --python 3.14
          uv pip install -r requirements_lock.txt
          uv sync --locked --extra dev

      - name: Check formatting (Prettier)
        run: npm run format

      - name: Lint TypeScript/React (ESLint)
        run: npx eslint

      - name: Type-check TypeScript
        run: npm run typecheck

      - name: Run Vitest suite
        run: npx vitest run --passWithNoTests

      - name: Check Python formatting (Ruff)
        run: uv run ruff format --check

      - name: Lint Python (Ruff)
        run: uv run ruff check --force-exclude

      - name: Type-check Python (mypy)
        run: uv run mypy scripts

      - name: Type-check Python (pyright)
        run: uv run pyright

      - name: Run tests and print test coverage output
        run: uv run pytest --cov=scripts --cov-branch scripts/tests
